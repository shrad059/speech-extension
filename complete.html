<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Audio Translation</title>
</head>
<body>
    <h1>Real-Time Audio Translation</h1>
    <button id="recordButton">Start Recording</button>
    <button id="stopButton" disabled>Stop Recording</button>
    <p id="status"></p>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        let recordButton = document.getElementById("recordButton");
        let stopButton = document.getElementById("stopButton");
        let status = document.getElementById("status");
        let mediaRecorder;
        let audioChunks = [];
        let socket = io.connect('http://' + document.domain + ':' + location.port);

        recordButton.addEventListener("click", startRecording);
        stopButton.addEventListener("click", stopRecording);

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRecorder.start(100); // capture chunks every 100ms

                    mediaRecorder.addEventListener("dataavailable", event => {
                        if (event.data.size > 0) {
                            socket.emit('audio_chunk', event.data);
                        }
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        socket.emit('end_audio');
                        status.innerText = "Stopped recording.";
                    });

                    status.innerText = "Recording...";
                    recordButton.disabled = true;
                    stopButton.disabled = false;
                })
                .catch(error => {
                    console.error('Error:', error);
                    status.innerText = "Error accessing microphone.";
                });
        }

        function stopRecording() {
            mediaRecorder.stop();
            recordButton.disabled = false;
            stopButton.disabled = true;
        }

        socket.on('translated_audio', function(data) {
            let audioData = new Blob([new Uint8Array(data.data.split('').map(c => c.charCodeAt(0)))], { type: 'audio/wav' });
            let audio = new Audio(URL.createObjectURL(audioData));
            audio.play();
        });
    </script>
</body>
</html>
